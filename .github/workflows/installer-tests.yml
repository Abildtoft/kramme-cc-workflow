name: Installer Tests

on:
  pull_request:

jobs:
  install:
    name: "${{ matrix.plugin }} -> ${{ matrix.target }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: [kramme-cc-workflow, kramme-connect-workflow]
        target: [opencode, codex]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute expected counts
        id: expected
        run: |
          node ./kramme-cc-workflow/scripts/convert-plugin.js stats "${{ matrix.plugin }}" >> "$GITHUB_OUTPUT"

      - name: Run installer
        run: |
          export OPENCODE_OUT="$RUNNER_TEMP/opencode"
          export CODEX_HOME="$RUNNER_TEMP/.codex"
          export AGENTS_HOME="$RUNNER_TEMP/.agents"
          mkdir -p "$OPENCODE_OUT" "$CODEX_HOME" "$AGENTS_HOME"

          ./${{ matrix.plugin }}/scripts/install-${{ matrix.target }}.sh \
            --non-interactive \
            --output "$OPENCODE_OUT" \
            --codex-home "$CODEX_HOME" \
            --agents-home "$AGENTS_HOME"

      - name: Verify opencode output
        if: matrix.target == 'opencode'
        run: |
          OUT="$RUNNER_TEMP/opencode"
          EXPECTED_SKILLS="${{ steps.expected.outputs.opencode_skills }}"
          EXPECTED_AGENTS="${{ steps.expected.outputs.agent_skills }}"

          test -f "$OUT/opencode.json"
          node -e "JSON.parse(require('fs').readFileSync('$OUT/opencode.json', 'utf8'))"

          if [ -d "$OUT/skills" ]; then
            SKILL_COUNT=$(find "$OUT/skills" -name "SKILL.md" | wc -l)
          else
            SKILL_COUNT=0
          fi

          if [ -d "$OUT/agents" ]; then
            AGENT_COUNT=$(find "$OUT/agents" -name "*.md" | wc -l)
          else
            AGENT_COUNT=0
          fi

          echo "Expected skills: $EXPECTED_SKILLS"
          echo "Installed skills: $SKILL_COUNT"
          test "$SKILL_COUNT" -eq "$EXPECTED_SKILLS"

          echo "Expected agents: $EXPECTED_AGENTS"
          echo "Installed agents: $AGENT_COUNT"
          test "$AGENT_COUNT" -eq "$EXPECTED_AGENTS"

          echo "--- Output tree ---"
          find "$OUT" -type f | sort

      - name: Verify codex output
        if: matrix.target == 'codex'
        run: |
          CODEX="$RUNNER_TEMP/.codex"
          AGENTS="$RUNNER_TEMP/.agents"
          EXPECTED_CODEX_SKILLS="${{ steps.expected.outputs.codex_skills }}"
          EXPECTED_AGENT_SKILLS="${{ steps.expected.outputs.agent_skills }}"

          if [ -d "$CODEX/skills" ]; then
            CODEX_SKILLS=$(find "$CODEX/skills" -name "SKILL.md" | wc -l)
          else
            CODEX_SKILLS=0
          fi

          if [ -d "$AGENTS/skills" ]; then
            AGENT_SKILLS=$(find "$AGENTS/skills" -name "SKILL.md" | wc -l)
          else
            AGENT_SKILLS=0
          fi

          echo "Expected codex skills: $EXPECTED_CODEX_SKILLS"
          echo "Installed codex skills: $CODEX_SKILLS"
          test "$CODEX_SKILLS" -eq "$EXPECTED_CODEX_SKILLS"

          echo "Expected agent skills: $EXPECTED_AGENT_SKILLS"
          echo "Installed agent skills: $AGENT_SKILLS"
          test "$AGENT_SKILLS" -eq "$EXPECTED_AGENT_SKILLS"

          test -f "$CODEX/AGENTS.md"

          echo "--- Codex tree ---"
          find "$CODEX" -type f | sort
          echo "--- Agents tree ---"
          find "$AGENTS" -type f 2>/dev/null | sort
