name: Installer Tests

on:
  pull_request:

jobs:
  install:
    name: "${{ matrix.plugin }} -> ${{ matrix.target }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: [kramme-cc-workflow, kramme-connect-workflow]
        target: [opencode, codex]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Compute expected counts
        id: expected
        run: |
          node - "${{ matrix.plugin }}" >> "$GITHUB_OUTPUT" <<'NODE'
          const fs = require("fs")
          const path = require("path")

          const pluginRoot = process.argv[2]

          function walkFiles(dir) {
            if (!fs.existsSync(dir)) return []
            const entries = fs.readdirSync(dir, { withFileTypes: true })
            const files = []
            for (const entry of entries) {
              const fullPath = path.join(dir, entry.name)
              if (entry.isDirectory()) {
                files.push(...walkFiles(fullPath))
              } else if (entry.isFile()) {
                files.push(fullPath)
              }
            }
            return files
          }

          function parsePlatforms(content) {
            const frontmatterMatch = content.match(/^---\r?\n([\s\S]*?)\r?\n---(?:\r?\n|$)/)
            if (!frontmatterMatch) return null

            const lines = frontmatterMatch[1].split(/\r?\n/)
            for (let i = 0; i < lines.length; i += 1) {
              const line = lines[i]

              const inline = line.match(/^kramme-platforms:\s*\[(.*)\]\s*$/i)
              if (inline) {
                return inline[1]
                  .split(",")
                  .map((token) => token.trim().replace(/^['"]|['"]$/g, "").toLowerCase())
                  .filter(Boolean)
              }

              const scalar = line.match(/^kramme-platforms:\s*([^\s#].*)$/i)
              if (scalar) {
                return scalar[1]
                  .split(",")
                  .map((token) => token.trim().replace(/^['"]|['"]$/g, "").toLowerCase())
                  .filter(Boolean)
              }

              if (/^kramme-platforms:\s*$/i.test(line)) {
                const values = []
                for (let j = i + 1; j < lines.length; j += 1) {
                  const candidate = lines[j]
                  const item = candidate.match(/^\s*-\s*(.+)\s*$/)
                  if (!item) break
                  values.push(item[1].trim().replace(/^['"]|['"]$/g, "").toLowerCase())
                }
                return values.length > 0 ? values : null
              }
            }

            return null
          }

          function countSkillsForTarget(target) {
            const skillFiles = walkFiles(path.join(pluginRoot, "skills"))
              .filter((file) => path.basename(file) === "SKILL.md")

            return skillFiles.filter((file) => {
              const content = fs.readFileSync(file, "utf8")
              const platforms = parsePlatforms(content)
              return !platforms || platforms.includes(target)
            }).length
          }

          const agentCount = walkFiles(path.join(pluginRoot, "agents"))
            .filter((file) => file.endsWith(".md"))
            .length

          console.log(`opencode_skills=${countSkillsForTarget("opencode")}`)
          console.log(`codex_skills=${countSkillsForTarget("codex")}`)
          console.log(`agent_skills=${agentCount}`)
          NODE

      - name: Run installer
        run: |
          export OPENCODE_OUT="$RUNNER_TEMP/opencode"
          export CODEX_HOME="$RUNNER_TEMP/.codex"
          export AGENTS_HOME="$RUNNER_TEMP/.agents"
          mkdir -p "$OPENCODE_OUT" "$CODEX_HOME" "$AGENTS_HOME"

          ./${{ matrix.plugin }}/scripts/install-${{ matrix.target }}.sh \
            --non-interactive \
            --output "$OPENCODE_OUT" \
            --codex-home "$CODEX_HOME" \
            --agents-home "$AGENTS_HOME"

      - name: Verify opencode output
        if: matrix.target == 'opencode'
        run: |
          OUT="$RUNNER_TEMP/opencode"
          EXPECTED_SKILLS="${{ steps.expected.outputs.opencode_skills }}"
          EXPECTED_AGENTS="${{ steps.expected.outputs.agent_skills }}"

          test -f "$OUT/opencode.json"
          node -e "JSON.parse(require('fs').readFileSync('$OUT/opencode.json', 'utf8'))"

          if [ -d "$OUT/skills" ]; then
            SKILL_COUNT=$(find "$OUT/skills" -name "SKILL.md" | wc -l)
          else
            SKILL_COUNT=0
          fi

          if [ -d "$OUT/agents" ]; then
            AGENT_COUNT=$(find "$OUT/agents" -name "*.md" | wc -l)
          else
            AGENT_COUNT=0
          fi

          echo "Expected skills: $EXPECTED_SKILLS"
          echo "Installed skills: $SKILL_COUNT"
          test "$SKILL_COUNT" -eq "$EXPECTED_SKILLS"

          echo "Expected agents: $EXPECTED_AGENTS"
          echo "Installed agents: $AGENT_COUNT"
          test "$AGENT_COUNT" -eq "$EXPECTED_AGENTS"

          echo "--- Output tree ---"
          find "$OUT" -type f | sort

      - name: Verify codex output
        if: matrix.target == 'codex'
        run: |
          CODEX="$RUNNER_TEMP/.codex"
          AGENTS="$RUNNER_TEMP/.agents"
          EXPECTED_CODEX_SKILLS="${{ steps.expected.outputs.codex_skills }}"
          EXPECTED_AGENT_SKILLS="${{ steps.expected.outputs.agent_skills }}"

          if [ -d "$CODEX/skills" ]; then
            CODEX_SKILLS=$(find "$CODEX/skills" -name "SKILL.md" | wc -l)
          else
            CODEX_SKILLS=0
          fi

          if [ -d "$AGENTS/skills" ]; then
            AGENT_SKILLS=$(find "$AGENTS/skills" -name "SKILL.md" | wc -l)
          else
            AGENT_SKILLS=0
          fi

          echo "Expected codex skills: $EXPECTED_CODEX_SKILLS"
          echo "Installed codex skills: $CODEX_SKILLS"
          test "$CODEX_SKILLS" -eq "$EXPECTED_CODEX_SKILLS"

          echo "Expected agent skills: $EXPECTED_AGENT_SKILLS"
          echo "Installed agent skills: $AGENT_SKILLS"
          test "$AGENT_SKILLS" -eq "$EXPECTED_AGENT_SKILLS"

          if [ "$EXPECTED_AGENT_SKILLS" -gt 0 ]; then
            test -f "$CODEX/AGENTS.md"
          fi

          echo "--- Codex tree ---"
          find "$CODEX" -type f | sort
          echo "--- Agents tree ---"
          find "$AGENTS" -type f 2>/dev/null | sort
